FROM node:16-alpine

ARG PORT
ARG EXPRESS_LISTEN_APP_PORT
ARG ELEPHANT_API_KEY
ARG STRIPE_SECRET_API_KEY
ARG GITHUB_ACTIONS
ARG DOCKER_CONTAINER=true

ENV PORT=$PORT
ENV EXPRESS_LISTEN_APP_PORT=$EXPRESS_LISTEN_APP_PORT
ENV ELEPHANT_API_KEY=$ELEPHANT_API_KEY
ENV STRIPE_SECRET_API_KEY=$STRIPE_SECRET_API_KEY
ENV GITHUB_ACTIONS=$GITHUB_ACTIONS
ENV DOCKER_CONTAINER=$DOCKER_CONTAINER

WORKDIR /usr/be-a-savior/server

COPY *.json ./
COPY *.lock ./

RUN yarn install:ci

COPY . .

RUN yarn test:unit

CMD yarn prepare:test:integration && yarn test:integration
